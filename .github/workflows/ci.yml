name: CI/CD Pipeline - ReLiS

# -----------------------------------------------------------------------------
# D√âCLENCHEURS (TRIGGERS)
# Ici, on d√©finit quand le robot doit se r√©veiller.
# On veut tester le code √† chaque fois qu'on pousse sur 'main' ou qu'on ouvre une PR.
# -----------------------------------------------------------------------------
on:
  push:
    branches: [ "main", "feature/*" ] # On surveille aussi les features en cours
  pull_request:
    branches: [ "main" ]

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1 : QUALIT√â & SANT√â DU CODE
  # L'objectif est de d√©tecter les erreurs b√™tes (syntaxe, config) avant qu'elles n'arrivent en prod.
  # ---------------------------------------------------------------------------
  code-quality:
    name: üîç Quality Check
    runs-on: ubuntu-latest # On utilise une machine virtuelle Linux standard

    steps:
      # √âtape 1 : R√©cup√©ration du code
      # Sans √ßa, le robot travaille sur un dossier vide.
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # √âtape 2 : Pr√©paration de l'environnement PHP
      # On installe la m√™me version que celle utilis√©e dans notre Dockerfile (8.2)
      # pour √©viter les surprises du type "√ßa marche chez moi mais pas ici".
      - name: üõ†Ô∏è Setup PHP environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql # Les extensions requises par notre app

      # √âtape 3 : Chasse aux erreurs de syntaxe (Linting)
      # Cette commande parcourt tous les fichiers .php du dossier src/
      # Si on a oubli√© un point-virgule quelque part, √ßa p√®te ici.
      - name: üîé PHP Syntax Check (Lint)
        run: find src -name "*.php" -print0 | xargs -0 -n1 php -l

      # √âtape 4 : Validation de la config Docker
      # On v√©rifie juste que le fichier docker-compose.yml est valide et bien indent√©.
      # √áa √©vite de casser la prod avec une erreur YAML.
      - name: üê≥ Validate Docker Compose config
        run: docker compose config

  # ---------------------------------------------------------------------------
  # JOB 2 : AUDIT DE S√âCURIT√â (La touche "DevOps")
  # On scanne le projet pour trouver des failles connues (CVE).
  # Ce job ne se lance que si le job pr√©c√©dent (code-quality) a r√©ussi.
  # ---------------------------------------------------------------------------
  security-audit:
    name: üõ°Ô∏è Security Scan
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # On utilise Trivy, c'est le standard actuel pour scanner les failles.
      # C'est un point fort √† mentionner en entretien.
      - name: üö® Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # On scanne le File System (les fichiers)
          scan-ref: '.'
          format: 'table' # Affiche un joli tableau dans les logs
          # On met exit-code √† 0 pour ne pas bloquer le pipeline m√™me si une faille est trouv√©e
          # (En prod, on mettrait 1 pour bloquer le d√©ploiement)
          exit-code: '0'
          severity: 'CRITICAL,HIGH' # On ne veut voir que les vrais probl√®mes