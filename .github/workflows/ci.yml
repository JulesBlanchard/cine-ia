name: CI/CD Pipeline - ReLiS

# -----------------------------------------------------------------------------
# DÃ‰CLENCHEURS (TRIGGERS)
# Ici, on dÃ©finit quand le robot doit se rÃ©veiller.
# On veut tester le code Ã  chaque fois qu'on pousse sur 'main' ou qu'on ouvre une PR.
# -----------------------------------------------------------------------------
on:
  push:
    branches: [ "main", "feature/*" ] # On surveille aussi les features en cours
  pull_request:
    branches: [ "main" ]

jobs:
  # ---------------------------------------------------------------------------
  # JOB 1 : QUALITÃ‰ & SANTÃ‰ DU CODE
  # L'objectif est de dÃ©tecter les erreurs bÃªtes (syntaxe, config) avant qu'elles n'arrivent en prod.
  # ---------------------------------------------------------------------------
  code-quality:
    name: ğŸ” Quality Check
    runs-on: ubuntu-latest # On utilise une machine virtuelle Linux standard

    steps:
      # Ã‰tape 1 : RÃ©cupÃ©ration du code
      # Sans Ã§a, le robot travaille sur un dossier vide.
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Ã‰tape 2 : PrÃ©paration de l'environnement PHP
      # On installe la mÃªme version que celle utilisÃ©e dans notre Dockerfile (8.2)
      # pour Ã©viter les surprises du type "Ã§a marche chez moi mais pas ici".
      - name: ğŸ› ï¸ Setup PHP environment
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, intl, pdo, pdo_mysql # Les extensions requises par notre app

      # Ã‰tape 3 : Chasse aux erreurs de syntaxe (Linting)
      - name: ğŸ” PHP Syntax Check (Lint)
        run: find src -name "*.php" -print0 | xargs -0 -n1 php -l

      # --- AJOUT ICI ---
      # Docker a besoin du fichier .env pour dÃ©marrer, mÃªme s'il est vide.
      # Comme on ne l'a pas mis sur GitHub (sÃ©curitÃ©), on en crÃ©e un faux ici.
      - name: ğŸ”’ Create dummy .env file
        run: touch .env
      # -----------------

      # Ã‰tape 4 : Validation de la config Docker
      - name: ğŸ³ Validate Docker Compose config
        run: docker compose config

  # ---------------------------------------------------------------------------
  # JOB 2 : AUDIT DE SÃ‰CURITÃ‰ (La touche "DevOps")
  # On scanne le projet pour trouver des failles connues (CVE).
  # Ce job ne se lance que si le job prÃ©cÃ©dent (code-quality) a rÃ©ussi.
  # ---------------------------------------------------------------------------
  security-audit:
    name: ğŸ›¡ï¸ Security Scan
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # On utilise Trivy, c'est le standard actuel pour scanner les failles.
      # C'est un point fort Ã  mentionner en entretien.
      - name: ğŸš¨ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs' # On scanne le File System (les fichiers)
          scan-ref: '.'
          format: 'table' # Affiche un joli tableau dans les logs
          # On met exit-code Ã  0 pour ne pas bloquer le pipeline mÃªme si une faille est trouvÃ©e
          # (En prod, on mettrait 1 pour bloquer le dÃ©ploiement)
          exit-code: '0'
          severity: 'CRITICAL,HIGH' # On ne veut voir que les vrais problÃ¨mes